import requests
import time
import re
import json

# === Endpoints ===
SSE_URL = "https://vendorstool-app-6b0n96.dw4w1g-1.gbr-e1.cloudhub.io/sse"
BASE_MESSAGE_URL = "https://vendorstool-app-6b1n96.dw4w1g-1.gbr-e1.cloudhub.io/message"

# === Headers and Payload ===
headers = {
    "Content-Type": "application/json"
}

payload = {
    "method": "tools/call",
    "params": {
        "name": "get-vendors",
        "arguments": {}
    }
}

# === Utilities ===
def get_session_id(prompt, timeout=300):
    print(prompt)
    try:
        with requests.get(SSE_URL, stream=True, timeout=timeout) as response:
            if response.status_code == 200:
                for line in response.iter_lines():
                    if line:
                        decoded = line.decode("utf-8")
                        print("ğŸ“¡ SSE:", decoded)
                        match = re.search(r'data: /message\?sessionId=([a-f0-9\-]+)', decoded)
                        if match:
                            session_id = match.group(1)
                            print("âœ… Session ID found:", session_id)
                            return session_id
            else:
                print("âŒ Failed to connect to SSE. Status:", response.status_code)
    except Exception as e:
        print("âŒ SSE connection error:", e)
    return None

def send_request(session_id, method="GET", label="Request"):
    url = f"{BASE_MESSAGE_URL}?sessionId={session_id}"
    try:
        print(f"ğŸ“¤ Sending {label} {method.upper()} request to server...")
        if method.upper() == "POST":
            response = requests.post(url, headers=headers, json=payload, timeout=60)
        else:
            response = requests.get(url, timeout=60)

        print(f"âœ… {label} {method.upper()} Status: {response.status_code}")
        print(f"ğŸ“¨ {label} Response: {response.text}")
        return response.status_code in [200, 202]
    except Exception as e:
        print(f"âŒ {label} {method.upper()} request failed:", e)
    return False

def listen_for_final_data(timeout=180):
    print("ğŸ‘‚ Listening for final vendor data...")
    try:
        with requests.get(SSE_URL, stream=True, timeout=timeout) as response:
            if response.status_code == 200:
                for line in response.iter_lines():
                    if line:
                        decoded = line.decode("utf-8")
                        print("ğŸ“¦ SSE:", decoded)

                        data_match = re.search(r'data: (.+)', decoded)
                        if data_match:
                            raw = data_match.group(1)
                            try:
                                data_json = json.loads(raw)
                                print("âœ…âœ… Final Vendor Data Received:")
                                print(json.dumps(data_json, indent=2))

                                # Optionally write to file
                                with open("final_vendor_data.json", "w") as f:
                                    json.dump(data_json, f, indent=2)
                                print("ğŸ’¾ Final data saved to final_vendor_data.json")

                                return True
                            except json.JSONDecodeError:
                                continue
            else:
                print("âŒ SSE reconnect failed. Status:", response.status_code)
    except Exception as e:
        print("âŒ Error while listening for final data:", e)
    return False

# === Main Flow ===
if __name__ == "__main__":
    print("ğŸš€ Connecting to MCP server...")

    # Step 1: Get initial session ID
    initial_session_id = get_session_id("ğŸ”Œ Waiting for initial session ID...")
    if initial_session_id:
        print("âœ… Server is connected.")

        # Step 2: Send initial GET (based on your Postman behavior)
        if send_request(initial_session_id, method="GET", label="Initial"):
            print("â³ Waiting 120 seconds for server to initialize...")
            time.sleep(120)

            # Step 3: Trigger run session
            run_session_id = get_session_id("ğŸ¯ Waiting for run session ID...")
            if run_session_id and send_request(run_session_id, method="GET", label="Run"):
                print("â³ Waiting 5 seconds before final session ID...")
                time.sleep(5)

                # Step 4: Final session
                final_session_id = get_session_id("ğŸ§¾ Waiting for final session ID...")
                if final_session_id and send_request(final_session_id, method="GET", label="Final"):
                    print("â³ Waiting 5 seconds before listening for final data...")
                    time.sleep(5)

                    if not listen_for_final_data():
                        print("âŒ Final vendor data not received.")
                else:
                    print("âŒ Final session ID or GET failed.")
            else:
                print("âŒ Run session ID or GET failed.")
        else:
            print("âŒ Initial GET failed. Server rejected the request.")
    else:
        print("âŒ No session ID received. Server not connected.")
