import os
import xml.etree.ElementTree as ET
from langchain.schema import HumanMessage
from langchain_community.chat_models import AzureChatOpenAI
from langgraph.checkpoint.memory import MemorySaver
from langgraph.prebuilt import create_react_agent

# === Set up Azure OpenAI Model ===
def get_openai_model():
    return AzureChatOpenAI(
        azure_endpoint="https://testopenaiassets.openai.azure.com",
        deployment_name="Fourth_Chatbot",
        openai_api_key="YOUR_API_KEY_HERE",  # ‚úÖ Replace with your Azure key
        openai_api_version="2024-08-01-preview",
        temperature=0.7,
        top_p=0.9,
        frequency_penalty=0.2,
        presence_penalty=0.1,
        max_tokens=2000
    )

# === Find XML files inside 'src/main/mule' folders ===
def find_all_mule_xml_files(folder_path):
    xml_files = []
    for root, dirs, files in os.walk(folder_path):
        normalized_root = os.path.normpath(root)
        if normalized_root.endswith(os.path.normpath(os.path.join("src", "main", "mule"))):
            for file in files:
                if file.endswith(".xml"):
                    xml_files.append(os.path.join(root, file))
            for sub_root, _, sub_files in os.walk(root):
                if sub_root != root:
                    for file in sub_files:
                        if file.endswith(".xml"):
                            xml_files.append(os.path.join(sub_root, file))
            break
    return xml_files

# === Summarize a single XML file using LangGraph agent ===
def summarize_xml_file(xml_path, agent_executor, config):
    try:
        tree = ET.parse(xml_path)
        root = tree.getroot()
        xml_content = ET.tostring(root, encoding='unicode', method='xml')

        prompt = (
            f"You are a MuleSoft integration expert. Given the following XML file, write a detailed, plain-English explanation "
            f"of what it does. Focus on flows, subflows, connectors, logic, and how it fits in an integration architecture.\n\n"
            f"### XML: {os.path.basename(xml_path)}\n"
            f"{xml_content}\n\n"
            f"Generate a helpful summary. Don't repeat the XML. Explain its structure and meaning clearly."
        )

        response = ""
        for step in agent_executor.stream({"messages": [HumanMessage(content=prompt)]}, config, stream_mode="values"):
            response += step["messages"][-1].content

        return f"\n---\nüßæ Summary of `{os.path.basename(xml_path)}`\n{response.strip()}"
    except ET.ParseError as e:
        return f"‚ùå Error parsing {xml_path}: {str(e)}"
    except Exception as e:
        return f"‚ùå Unexpected error in {xml_path}: {str(e)}"

# === Combine all summaries into a final explanation ===
def summarize_all_collected_content(all_summaries, agent_executor, config):
    combined_content = "\n\n".join(all_summaries)
    final_prompt = (
        "You are a senior MuleSoft integration expert. Given the following summaries of various XML files, "
        "write a detailed one-pager explaining how the entire integration system works. Focus on architecture, "
        "flows, key processors, logic, error handling, and any API endpoints involved. Keep it accurate and helpful.\n\n"
        "### XML Summaries:\n"
        f"{combined_content}"
    )

    response = ""
    for step in agent_executor.stream({"messages": [HumanMessage(content=final_prompt)]}, config, stream_mode="values"):
        response += step["messages"][-1].content

    return response.strip()

# === MAIN ===
if __name__ == "__main__":
    project_root = r"C:\Users\rdamera\Downloads\OrderManagement 1"  # üëà Your local path

    try:
        print("üîç Scanning for MuleSoft XML files...\n")
        xml_files = find_all_mule_xml_files(project_root)

        if not xml_files:
            print("‚ö†Ô∏è No MuleSoft XML files found in 'src/main/mule'.")
        else:
            print(f"‚úÖ Found {len(xml_files)} XML file(s):")
            for file in xml_files:
                print(f"- {os.path.basename(file)}")

            # === Create LangGraph agent with memory ===
            memory = MemorySaver()
            model = get_openai_model()
            tools = []  # Tools can be added if needed in future
            agent_executor = create_react_agent(model, tools, checkpointer=memory)
            config = {"configurable": {"thread_id": "mule-session-001"}}

            # === Summarize each XML ===
            xml_summaries = []
            for xml_path in xml_files:
                print(f"\nüìù Summarizing: {os.path.basename(xml_path)}")
                summary = summarize_xml_file(xml_path, agent_executor, config)
                xml_summaries.append(summary)

            print("\nüì¶ Finished summarizing all files.")
            print("üß† Generating final one-pager summary...\n")

            final_summary = summarize_all_collected_content(xml_summaries, agent_executor, config)

            print("====== üìÑ FINAL ONE-PAGER DOCUMENTATION ======\n")
            print(final_summary)

    except Exception as e:
        print(f"‚ùå An error occurred: {str(e)}")
