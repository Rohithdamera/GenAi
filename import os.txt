import os
import asyncio
from typing import List, Dict, Any
from mcp import ClientSession
from mcp.client.sse import sse_client

from langchain.agents import initialize_agent, AgentType
from langchain.agents.agent_toolkits import Tool
from langchain.chat_models import AzureChatOpenAI
from langchain.agents.agent import AgentExecutor

# -------------------------
# 1. Azure OpenAI Client
# -------------------------
def get_openai_client():
    return AzureChatOpenAI(
        azure_deployment="Fourth_Chatbot",
        azure_endpoint="https://testopenaiassets.openai.azure.com",
        openai_api_version="2024-08-01-preview",
        openai_api_key=os.getenv("AZURE_OPENAI_KEY", ""),
        temperature=0.7,
        max_tokens=2000,
        model_kwargs={
            "top_p": 0.9,
            "frequency_penalty": 0.2,
            "presence_penalty": 0.1
        }
    )

# -------------------------
# 2. MCP Tool Wrappers
# -------------------------
class MCPToolWrapper:
    def __init__(self, session: ClientSession):
        self.session = session

    async def get_available_tools(self) -> List[str]:
        return await self.session.list_tools()

    async def call_tool(self, tool_name: str, params: Dict[str, Any]) -> Any:
        return await self.session.call_tool(tool_name, params)


# -------------------------
# 3. AsyncTool Adapter
# -------------------------
def create_langchain_tools(tools: List[str], wrapper: MCPToolWrapper):
    from langchain.tools import tool

    lc_tools = []

    for tool_name in tools:
        @tool(name=tool_name, description=f"Call the {tool_name} tool")
        async def _call_tool(tool_input: str, tool_name=tool_name):
            import json
            try:
                params = json.loads(tool_input)
            except:
                return f"Input must be a JSON string. Got: {tool_input}"

            result = await wrapper.call_tool(tool_name, params)
            return str(result)

        lc_tools.append(_call_tool)

    return lc_tools


# -------------------------
# 4. Main REACT Agent Runner
# -------------------------
async def run_agent():
    url = "https://employee-mcp-v1-6b0n96.dw4w1g-2.gbr-e1.cloudhub.io/sse"

    async with sse_client(url=url) as streams:
        async with ClientSession(streams[0], streams[1]) as session:
            await session.initialize()

            wrapper = MCPToolWrapper(session)
            available_tools = await wrapper.get_available_tools()
            print("üîß MCP Tools Available:", available_tools)

            # Wrap tools for LangChain agent
            langchain_tools = create_langchain_tools(available_tools, wrapper)

            # Initialize agent with OpenAI + tools
            agent = initialize_agent(
                tools=langchain_tools,
                llm=get_openai_client(),
                agent=AgentType.OPENAI_FUNCTIONS,
                verbose=True,
                handle_parsing_errors=True
            )

            print("\nü§ñ Ask your question (e.g. 'Who works on Pepsico?')")
            while True:
                user_query = input("\nUser: ")
                if user_query.lower() in ["exit", "quit"]:
                    break
                try:
                    result = await agent.arun(user_query)
                    print(f"Agent: {result}")
                except Exception as e:
                    print(f"‚ùå Agent Error: {e}")

# -------------------------
# 5. Run main
# -------------------------
if __name__ == "__main__":
    asyncio.run(run_agent())
