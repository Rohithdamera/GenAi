import os
import json
import logging
import random
import string
from base64 import b64decode

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

def random_value(value):
    if isinstance(value, str):
        return ''.join(random.choices(string.ascii_letters + string.digits, k=len(value)))
    elif isinstance(value, int):
        return random.randint(1000, 9999)
    elif isinstance(value, float):
        return round(random.uniform(1.0, 9999.9), 2)
    elif isinstance(value, list):
        return [random_value(v) for v in value]
    elif isinstance(value, dict):
        return {k: random_value(v) for k, v in value.items()}
    return value

def regenerate_payload_values(json_data):
    return random_value(json_data)

def lambda_handler(event, context):
    logger.info("Lambda invoked for RAML JSON file.")
    try:
        if 'body' not in event or not event.get('isBase64Encoded', False):
            raise ValueError("File content is missing or not base64-encoded.")

        # Decode the RAML content from base64
        raml_bytes = b64decode(event['body'])
        raml_content = raml_bytes.decode('utf-8', errors='ignore')

        try:
            # Parse entire content directly as JSON
            original_json = json.loads(raml_content)
        except json.JSONDecodeError as e:
            raise ValueError("RAML file does not contain valid JSON.")

        # Regenerate payload with randomized values
        randomized_payload = regenerate_payload_values(original_json)

        return {
            "statusCode": 200,
            "headers": {"Content-Type": "application/json"},
            "body": json.dumps(randomized_payload, indent=2)
        }

    except Exception as e:
        logger.error(f"Error during execution: {e}")
        return {
            "statusCode": 500,
            "body": json.dumps({"error": str(e)})
        }
