import os
import logging
import json
from base64 import b64decode
from Crypto.Cipher import AES
from langchain_community.chat_models import AzureChatOpenAI
from langchain.schema import HumanMessage

# Logging setup
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

def unpad(data):
    padding_length = data[-1]
    return data[:-padding_length]

def decrypt(data, key):
    cipher = AES.new(b64decode(key), AES.MODE_ECB)
    decrypted_data = cipher.decrypt(b64decode(data))
    return unpad(decrypted_data).decode()

def get_openai_client(model_instance_name):
    try:
        aes_key_base64 = os.environ['AES_KEY']
        encrypted_api_base = os.environ['ENCRYPTED_API_BASE']
        encrypted_api_key = os.environ['ENCRYPTED_API_KEY']
        api_version = os.environ['AZURE_API_VERSION']

        decrypted_api_base = decrypt(encrypted_api_base, aes_key_base64)
        decrypted_api_key = decrypt(encrypted_api_key, aes_key_base64)

        if not decrypted_api_base.endswith('/'):
            decrypted_api_base += '/'

        logger.info(f"Request URL: {decrypted_api_base}openai/deployments/{model_instance_name}/chat/completions?api-version={api_version}")

        return AzureChatOpenAI(
            deployment_name=model_instance_name,
            openai_api_base=decrypted_api_base,
            openai_api_key=decrypted_api_key,
            openai_api_version=api_version
        )
    except Exception as e:
        logger.error(f"OpenAI client initialization failed: {e}")
        raise ValueError(f"OpenAI client initialization failed: {e}")

def get_raml_prompt(file_content, iteration=None, total=None):
    base_instruction = (
        "You are an expert in analysing the RAML and generating the payload from the RAML. "
        "I am providing the RAML which will be used as an asset for designing my API. "
        "Please anlayze the RAML and generate the sample payload which will honour all the rules inside the RAML. "
        "You can refer the link for any doubts related to RAML: https://raml.org/developers/raml-100-tutorial"
    )

    main_prompt = "Please generate the payloads for all the endpoint in the RAML."

    variation_note = f" This is variation {iteration + 1} of {total}. Ensure different values from previous ones." if iteration is not None else ""

    return f"{base_instruction}\n\n{main_prompt}{variation_note}\n\nContent:\n{file_content}\n\nOnly return JSON."

def parse_response_as_json(response_content):
    """
    Attempts to extract JSON from the model's raw output.
    Handles cases like:
    - ```json ... ```
    - Triple quotes
    - Markdown blocks
    - Newline formatting
    """
    try:
        # Remove code fences if present
        cleaned = response_content.strip()
        if cleaned.startswith("```json"):
            cleaned = cleaned.replace("```json", "").replace("```", "").strip()
        elif cleaned.startswith("```"):
            cleaned = cleaned.replace("```", "").strip()
        # Try parsing
        return json.loads(cleaned)
    except Exception as e:
        logger.error(f"Raw response content that failed parsing:\n{response_content}")
        raise ValueError(f"Invalid JSON from model: {e}")

def process_with_openai(client, file_content, count):
    results = []
    for i in range(count):
        prompt = get_raml_prompt(file_content, i, count)
        try:
            response = client.invoke([HumanMessage(content=prompt)])
            parsed = parse_response_as_json(response.content)
            results.append(parsed)
        except Exception as e:
            logger.error(f"OpenAI call failed at iteration {i+1}: {e}")
            raise
    return results if count > 1 else results[0]

def lambda_handler(event, context):
    logger.info(f"Received event: {json.dumps(event)[:1000]}")  # Limit log size
    try:
        if 'body' not in event or not event.get('isBase64Encoded', False):
            raise ValueError("Missing or invalid file content.")

        raw_body = b64decode(event['body']).decode('utf-8', errors='ignore')
        headers = event.get('headers', {})
        params = event.get('queryStringParameters', {})

        model_instance_name = headers.get('model_instance_name')
        if not model_instance_name:
            raise ValueError("Missing 'model_instance_name' in headers.")

        count = int(headers.get('count', 1))
        input_param = params.get('input')

        if input_param != "/sampleforraml":
            raise ValueError("Unsupported input value. Only '/sampleforraml' is supported.")

        content_type = headers.get("Content-Type") or headers.get("content-type")
        if not content_type or "yaml" not in content_type.lower():
            raise ValueError("Content-Type must be 'application/yaml' for .yml files.")

        client = get_openai_client(model_instance_name)
        result = process_with_openai(client, raw_body, count)

        return {
            "statusCode": 200,
            "headers": {"Content-Type": "application/json"},
            "body": json.dumps(result, indent=2)
        }

    except Exception as e:
        logger.error(f"Processing failed: {e}")
        return {
            "statusCode": 500,
            "body": json.dumps({"error": str(e)})
        }
